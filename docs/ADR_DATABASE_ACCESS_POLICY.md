# ADR: データベースアクセスポリシー

**ステータス**: 承認済み
**日付**: 2026-02-19

---

## コンテキスト

DuckDB は「1ライター + Nリーダー」モデルを採用しており、同一ファイルへの同時書き込みはロックエラーとなる。
Dogfooding（自己登録スクリプト）の実行中に、MCP サーバーが稼働した状態でスクリプトから直接 DB に書き込もうとした結果、ファイルロック競合が発生した。

## 決定事項

### 1. 全ての DB 書き込みは MCP サーバー経由で行う

- **保存**: `save_function` MCP ツール経由
- **削除**: `delete_function` MCP ツール経由
- **バルク登録**: `import_function_pack` MCP ツール経由（または AI エージェントに `save_function` を繰り返し呼ばせる）
- **ダッシュボード（読み取り）**: `read_only=True` で接続（競合なし）

DB を直接操作するスクリプト（`dogfood_self.py` 等）は**禁止**とする。

### 2. PostgreSQL + pgvector への移行は「今ではない」

- 現状は個人利用（Solo-MCP）であり、DuckDB の 1ライターモデルで十分。
- チーム利用（Team-MCP）に進化する際に、PostgreSQL + pgvector を検討する。
- 移行の判断基準: **「複数ユーザーが同時に書き込む必要が出た時」**。

## 根拠

- MCP サーバーを唯一のライターとすることで、ファイルロックは**原理的に発生しない**。
- PostgreSQL 導入はセットアップコストを大幅に増加させ、「Local-First」の設計方針に反する。
- 問題の本質は DB エンジンではなく「アクセスパターン」であった。

## 影響

- `dev_tools/scripts/dogfood_self.py` と `cleanup_dogfood.py` を削除済み。
- 今後のバルク操作は全て MCP ツール経由で実施する。
