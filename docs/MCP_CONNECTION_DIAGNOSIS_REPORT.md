# Function Store MCP のAntigravity接続トラブルシューティング記録

このドキュメントは、Function Store MCPサーバーのセットアップ時に発生した接続および実行エラーの原因と、それらを解決に至らせた最終的な構成についての記録です。次回同様の問題が発生した際の参考にしてください。

## 1. 発生した問題と経緯

### 第1段階: HTTP (SSE) 接続の失敗
当初 `server.py` は `sse` (Server-Sent Events) モードで起動し、HTTPポート 8001 を使用して通信する構成でした。

*   **事象**: エージェント（クライアント）から `connection refused` や `EOF` エラーが発生し、接続が確立できない、あるいは直後に切断される。
*   **試行した対策**:
    1.  `mcp_config.json` の typo 修正 (`/see` -> `/sse`) -> **解決せず**。
    2.  IPv6 問題の回避: `localhost` を `127.0.0.1` に変更 -> **解決せず** (Windowsでは解決後も不安定)。
*   **分析 (なぜダメだったのか)**:
    *   Windows環境におけるローカルループバック接続は、ファイアウォール、IPv4/IPv6の優先順位、そしてポートの競合（ゾンビプロセス）の影響を受けやすい傾向があります。
    *   特にVSCodeのエージェントは接続維持の挙動が厳密であり、サーバー再起動時の再接続（Stale Socket）でつまずくケースが多発しました。

### 第2段階: Stdio への移行と実行環境エラー
ネットワーク起因の問題を回避するため、通信方式を `stdio` (標準入出力) に変更しました。

*   **事象**: `ModuleNotFoundError: No module named 'numpy'` が発生してサーバーが即座に終了する。
*   **原因**:
    *   `mcp_config.json` の `command` で `uv run` を実行した際、**カレントディレクトリ (CWD)** がプロジェクトルートとして認識されていませんでした。
    *   そのため、`uv` は `pyproject.toml` を見つけられず、仮想環境（`.venv`）ではなく、システムの標準Python環境を使ってしまい、依存ライブラリ (`numpy`等) が見つからない状態となりました。

## 2. 最終的な解決策と因果関係

これらの問題を解決するために、以下の2つの決定的な変更を行いました。

### A. 通信方式を `stdio` に変更 (ネットワーク問題の根治)
HTTPサーバーを立てるのをやめ、エージェントがサブプロセスとして直接 `python server.py` を起動し、標準入出力で会話する方式にしました。

*   **理由**: TCPポートを使わないため、ファイアウォールや他プロセスとのポート競合、IPv6問題が**原理的に発生しません**。
*   **結果**: `connection refused` や `EOF` エラーが完全に解消されました。

### B. `uv` に `--project` フラグを追加 (環境問題の根治)
`mcp_config.json` の引数に `--project <絶対パス>` を追加しました。

```json
"args": [
  "run",
  "--project",
  "c:/Users/saiha/My_Service/AI-agent/product/function_store_mcp", 
  "--no-sync",
  "python",
  ...
]
```

*   **理由**: どこからコマンドが実行されても、`uv` が確実に指定されたフォルダの `pyproject.toml` を読み込み、正しい仮想環境 (`.venv`) をアクティベートできるようにするため。
*   **結果**: `ModuleNotFoundError` が解消され、必要なライブラリが正しくロードされるようになりました。

## 3. 今後のための教訓 (Best Practices)

1.  **WindowsでのMCPは `stdio` 推奨**:
    *   ローカルで完結するMCPサーバーの場合、HTTP/SSEよりも `stdio` の方が圧倒的に安定します。デバッグ目的以外では `stdio` を第一選択肢とすべきです。

2.  **`uv` コマンドの絶対パス指定**:
    *   外部ツール（VSCode等のエージェント）から `uv` を呼ぶ際は、カレントディレクトリに依存しないよう、必ず `--project` フラグでパスを固定するか、絶対パス指定を徹底することで、「環境が見つからない」トラブルを防げます。
